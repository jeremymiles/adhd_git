---
title: "ADHD Adults Diagnosis"
format: 
  html:
    embed-resources: true
editor: visual
---

## *ADHD Adults Diagnosis*

```{r}

library(dplyr)
library(ggplot2)
library(ggrepel)
library(kableExtra)
library(metafor)
library(stringr)
library(tidyr)
library(writexl)

data_location <- "https://github.com/jeremymiles/adhd_git/raw/refs/heads/main/data/distillersr-AHRQ_Adult_ADHD_Diagnosis_and_Treatment_USC_2026-03-01-00-26-54.csv"

d <- read.csv(data_location)

### TEMP - REMOVE
d <- d %>%
  dplyr::filter(ID != "Harrison, 2019{#351}") 

capitalize_first <- function(s) {
  if (is.na(s) || s == "") { #Handle NAs and empty strings
    return(s)
  }
  first_letter <- str_sub(s, 1, 1)
  rest_of_string <- str_sub(s, 2)
  return(str_c(str_to_upper(first_letter), rest_of_string))
}
```

*You can add options to executable code like this*

```{r}
#|fig-height: 12
d_ss <- d %>% 
  dplyr::select(
    ID, size, starts_with("sensitivity"), starts_with("specificity"),
    test_description_self
  ) %>%
  dplyr::select(
    ID, size,
    ends_with(
      c("self_report", "neuropsycho_tests", "clinician_interview",
        "combination", "clinician_tool", "clinician_rating", 
        "peer_rating", "neuroimaging", "neuroimaging", 
        "observational", "biomarker", "EEG")
    )
  ) %>%
  dplyr::select(
    !starts_with(c(
      "sensitivity_CI", "specificity_CI", 
      "sensitivity_other", "specificity_other"))
  )

d_test_description_self <- d %>%
  dplyr::select(
    ID, test_description_self
  ) %>% 
  dplyr::distinct()

d_sens <- d_ss %>%
  dplyr::select(ID, starts_with("sens")
  )

d_spec <- d_ss %>%
  dplyr::select(ID, starts_with("spec")
  )

d_sens_long <- d_sens %>%
  tidyr::pivot_longer(
    cols = -ID
  ) %>%
  dplyr::rename(sensitivity = value)%>%
  dplyr::mutate(name = stringr::str_remove(name, "sensitivity_"))
  


d_spec_long <- d_spec %>%
  tidyr::pivot_longer(
    cols = -ID
  ) %>%
  dplyr::rename(specificity = value) %>%
  dplyr::mutate(name = stringr::str_remove(name, "specificity_"))


d_ss_long <- dplyr::full_join(
  d_sens_long, d_spec_long
) %>% 
  dplyr::filter(
    !is.na(sensitivity) & !is.na(specificity)
  ) %>% 
  dplyr::mutate(
    name = sapply(name, capitalize_first)
  ) %>%
  dplyr::mutate(
    name = stringr::str_replace_all(name, "_", " "),
    name = ifelse(
      name == "Neuropsycho tests", "Neuropsychological Test", name
      ),
    name = ifelse(
      name == "Self report", "Self-Report Questionnaire", name
      ),
    name = ifelse(
      name == "Peer rating", "Peer-Rating", name
      ),
    name = ifelse(
      name == "Clinician interview", "Clinician Tool", name
      ),
    
)

# mark neurotypicals
d_neurotypical <- d %>% dplyr::select(ID, Neurotypical, size) %>% 
  dplyr::mutate(
    Neurotypical = Neurotypical == "Neurotypical"
  )

d_neurotypical_Only <- d %>% 
  dplyr::mutate(
    Neurotypical_Only = Neurotypical == "Neurotypical" &
        Clinical != "Clinical" &
        Autism != "Autism" &
        Antisocial != "Antisocial" &
        Depression != "Depression" &
        Feigning != "Feigning"
  ) %>% dplyr::select(ID, Neurotypical_Only, size)


# count the number of different types of study
d_name_count <- data.frame(dplyr::bind_rows(
  c(name = "Combination", count = sum(d$Combination == "Combination")),
  c(name = "Biomarker", count = sum(d$Biomarker == "Biomarker")),
  c(name = "Clinician Tool", count = sum(d$Clinician.interview == "Clinician interview")),
  c(name = "EEG", count = sum(d$EEG == "EEG")),
  c(name = "Neuroimaging", count = sum(d$Neuroimaging == "Neuroimaging")),
  c(name = "Neuropsychological Test",   count = sum(d$Neuropsychological == "Neuropsychological")),
  c(name = "Peer-Rating",   count = sum(d$Peer.report == "Peer report")),
  c(name = "Self-Report Questionnaire",   count = sum(d$Self.report == "Self report"))
))

# merge with long data
d_ss_long <- d_ss_long %>%
  dplyr::full_join(
    d_neurotypical
  ) %>% 
  dplyr::full_join(
    d_neurotypical_Only
  ) %>% 
    dplyr::filter(!is.na(name))

ggplot2::ggplot(
  d_ss_long, 
  aes(
    x = sensitivity, 
    y = specificity)) +
  geom_point() +
  xlab("Sensitivity (%)") + 
  ylab("Specificity (%)")


d_ss_long <- d_ss_long %>%
  dplyr::full_join(d_name_count, by = "name") %>%
  dplyr::mutate(
    name_with_count = paste0(name, " (n = ", count, " studies)")
  )

ggplot2::ggplot(
  d_ss_long, 
  aes(
    x = sensitivity, 
    y = specificity,
    colour = name, shape = Neurotypical)) +
  geom_point(size = 2.5) +
  xlab("Sensitivity (%)") + 
  ylab("Specificity (%)") +
  facet_wrap(~ name_with_count) +
  guides(colour = "none") +
  theme(legend.position = "bottom")
```

```{r}

#Figure 8
ggplot2::ggplot(
  d_ss_long, 
  aes(
    x = sensitivity, 
    y = specificity,
    colour = name, shape = Neurotypical_Only)) +
  geom_point(size = 2.5) +
  xlab("Sensitivity") + 
  ylab("Specificity") +
  facet_wrap(~ name, nrow = 2) +
  guides(colour = "none") +
  labs(
    shape = "Neurotypical only"
  )

# separate charts
for (name_1 in d_ss_long$name) {
  plot <- ggplot2::ggplot(
    d_ss_long %>% dplyr::filter(name_1 == name), 
    aes(
      x = sensitivity, 
      y = specificity,
      shape = Neurotypical_Only)) +
    geom_point(size = 2.5) +
    xlab("Sensitivity") + 
    ylab("Specificity") +
    guides(colour = "none") +
    labs(
      shape = "Neurotypical only"
    ) +
    ggtitle(name_1)
  print(plot)
}


# Figure 8 separate charts

```

*Self report only*

```{r}

# this is figure 5
cat("self report<p>")
# 1. Prepare your data first
plot_data <- d_ss_long %>%
  dplyr::filter(
    name == "Self-Report Questionnaire"
  ) %>%
  dplyr::inner_join(
    d_test_description_self
  ) %>%
  dplyr::mutate(
    test_description = word(test_description_self, 1),
    size = size)



# Set colors for some
plot_data <- plot_data %>%
  dplyr::mutate(
    `Frequent Tools` = "Other",
    `Frequent Tools` = ifelse(substr(test_description, 1, 5) == "CAARS",
                              "CAARS", `Frequent Tools`),
    `Frequent Tools` = ifelse(substr(test_description, 1, 5) == "BAARS", 
                              "BAARS", `Frequent Tools`),
    `Frequent Tools` = ifelse(substr(test_description, 1, 4) == "ASRS", 
                              "ASRS", `Frequent Tools`),
    `Frequent Tools` = ifelse(substr(test_description, 1, 4) == "WURS", 
                              "WURS", `Frequent Tools`)
  )

plot_data %>%
  dplyr::group_by(test_description, `Frequent Tools`) %>%
  dplyr::summarise(n = dplyr::n()) %>%
  dplyr::arrange(desc(n)) %>%
  knitr::kable()

# 1. Define your colors in a named vector
# You must assign a color to every category, or the others will disappear/turn grey.
my_colors <- c(
  "ASRS"  = "red",    # Replace with your preferred color
  "CAARS" = "blue",   # Replace with your preferred color
  "BAARS" = "darkgreen",  # Replace with your preferred color
  "WURS" = "brown4",  # Replace with your preferred color
  "Other" = "black"   # The specific requirement
)

# 2. Plot
ggplot2::ggplot(
  data = plot_data, 
  aes(
    x = sensitivity,
    y = specificity,
    shape = Neurotypical_Only,
    size = size,
    color = `Frequent Tools`
  )
) +
  geom_point() +
  # 3. Add the manual scale
  scale_color_manual(values = my_colors) +
  xlab("Sensitivity (%)") +
  ylab("Specificity (%)") +
  ggrepel::geom_text_repel(
    aes(label = test_description), max.overlaps = 10, size = 3) +
  labs(
    shape = "Neurotypical only"
  ) +
  scale_size_continuous(
    name = "Size", # This sets the legend title
    breaks = c(50, 500, 1000), # Original untransformed values for legend
    labels = c("50", "500", "1000"), # Corresponding labels
    guide = "legend", # Explicitly request a legend
    # Set limits based on the *transformed* size values from your plot_data
    # This is crucial for the scale to match your actual plotted points
  ) +  theme(legend.position = "right")


d_test_description_np <- d %>%
  dplyr::select(
    ID, test_description_neuropsycho_tests, size
  ) %>% 
  dplyr::distinct() %>% 
  dplyr::mutate(
      test_description = word(test_description_neuropsycho_tests, 1)
  ) 

d_test_description_np %>%
  dplyr::group_by(test_description) %>%
  dplyr::summarise(n = dplyr::n()) %>%
  dplyr::arrange(desc(n)) %>%
  knitr::kable()

rm(plot_data)

# This is figure 6
cat("Neuropsychological \n Tests<p>")
plot_data <- d_ss_long %>%
  dplyr::filter(
    name == "Neuropsychological Test"
  ) %>%dplyr::inner_join(
    d_test_description_np
  ) %>%
  dplyr::mutate(test_description = word(test_description_neuropsycho_tests, 1)) 


# Set colors for some
plot_data <- plot_data %>%
  dplyr::mutate(
    `Frequent Tools` = "Other",
    `Frequent Tools` = 
      ifelse(substr(test_description, 1, 3) == "AQT", "AQT", `Frequent Tools`),
    `Frequent Tools` = 
      ifelse(substr(test_description, 1, 5) == "C-CPT", "C-CPT", `Frequent Tools`),
    `Frequent Tools` = 
      ifelse(substr(test_description, 1, 4) == "MOXO", "MOXO", `Frequent Tools`),
    `Frequent Tools` = 
      ifelse(substr(test_description, 1, 6) == "QbTest", "QbTest", `Frequent Tools`
             ),
    `Frequent Tools` = 
      ifelse(substr(test_description, 1, 5) == "Go-No", "Go-NoGo", `Frequent Tools`)
  )
  
  my_colors <- c(
  "AQT"  = "red",    # Replace with your preferred color
  "C-CPT" = "blue",   # Replace with your preferred color
  "MOXO" = "darkgreen",  # Replace with your preferred color
  "QbTest" = "chocolate4",
  "Go-NoGo" = "yellow",
  "Other" = "black"   # The specific requirement
)
  
  plot_data %>% ggplot2::ggplot(
    aes(
      x = sensitivity, 
      y = specificity,
      shape = Neurotypical_Only, size = size,
    color = `Frequent Tools`)
    ) +
  geom_point() +
  scale_color_manual(values = my_colors) +
  xlab("Sensitivity (%)") + 
  ylab("Specificity (%)") +
  geom_text_repel(aes(label = test_description), max.overlaps = 10, size = 3) +
    labs(
    shape = "Neurotypical only"
  ) +  theme(legend.position = "right")


```

```{r auc}

AUC_vars <- 
  d %>% dplyr::select(
    starts_with("AUC") 
  ) %>%
  dplyr::select(-starts_with("AUC_CI")) %>%
  names()
AUC_vars

d <- d %>%
  dplyr::mutate(
    group = dplyr::case_when(
      Neurotypical == "Neurotypical" &
        Clinical != "Clinical" &
        Autism != "Autism" &
        Antisocial != "Antisocial" &
        Depression != "Depression" &
        Feigning != "Feigning" ~ "Neurotypical",
      (Clinical == "Clinical" |
         Autism == "Autism" |
         Antisocial == "Antisocial" |
         Depression == "Depression") &
        Neurotypical != "Neurotypical" &
        Feigning != "Feigning" ~ "Clinical",
      Neurotypical == "Neurotypical" & (
        Clinical == "Clinical" |
          Autism == "Autism" |
          Antisocial == "Antisocial" |
          Depression == "Depression" |
          Feigning == "Feigning" # Include Feigning here if needed for "Both"
      ) ~ "Both (or more)",
      TRUE ~ NA_character_
    )
  ) 



d_long_accuracy <- d %>%
  dplyr::select(
    accuracy_biomarker,
    accuracy_combination,
    accuracy_EEG,
    accuracy_neuroimaging,
    accuracy_neuropsycho_tests,
    accuracy_observational,
    accuracy_peer_rating,
    accuracy_self_report,
    group
  ) %>% 
  dplyr::filter(!is.na(group)) %>%
  pivot_longer(
    cols = starts_with("accuracy_"),
    names_to = "accuracy_type",
    values_to = "accuracy_value",
    names_prefix = "accuracy_"
  )%>% 
  dplyr::mutate(measure = "accuracy") %>%
  dplyr::rename_with(~ gsub("accuracy_", "", .x), starts_with("accuracy"))




d_long_AUC <- d %>%
  dplyr::select(
    starts_with("AUC"),
    group
  ) %>% 
  dplyr::mutate(
    AUC_neuropsycho_tests = as.numeric(AUC_neuropsycho_tests)
  ) %>% 
  dplyr::select(-starts_with("AUC_CI")) %>% 
  dplyr::filter(!is.na(group)) %>%
  pivot_longer(
    cols = starts_with("AUC_"),
    names_to = "AUC_type",
    values_to = "AUC_value",
    names_prefix = "AUC_"
  ) %>% 
  dplyr::mutate(
    AUC_value = ifelse(
      AUC_value < 1, AUC_value * 100, AUC_value
    )
  ) %>% 
  dplyr::mutate(measure = "AUC") %>%
  dplyr::rename_with(~ gsub("AUC_", "", .x), starts_with("AUC")) %>%     
  dplyr::filter(!is.na(value)) %>% 
  dplyr::filter(type != "feigningADHD")

d_long_both <- dplyr::bind_rows(
  d_long_accuracy, d_long_AUC
) %>% dplyr::filter(!is.na(value))

# Make labels nicer.

d_long_both <- d_long_both %>%
  dplyr::mutate(
    type = dplyr::case_when(
     type == "biomarker" ~ "Biomarker",
     type == "clinician_interview" ~ "Clinician\nTool",
     type == "combination" ~ "Combination",
     type == "neuroimaging" ~ "Neuroimaging",
     type == "observational" ~ "Observational",
     type == "neuropsycho_tests" ~ "Neuro-\npsychological",
     type == "peer_rating" ~ "Peer\nRating",
     type == "self_report" ~ "Self-Report",
     .default = type
    ),
    measure = ifelse(measure == "accuracy", "Accuracy", measure)
  )
  


d_long_both %>% dplyr::filter(!is.na(value)) %>%
  dplyr::rename(Group = group) %>%
  ggplot2::ggplot(
    aes(x = Group, y = value)
  )  + 
  geom_boxplot() +
  facet_grid(type ~ measure)+
   theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Figure 7
d_long_both %>% dplyr::filter(!is.na(value)) %>%
  dplyr::rename(Group = group) %>%
  ggplot2::ggplot(
    aes(x = Group, y = value)
  )  + 
  geom_boxplot() +
  facet_grid(measure ~ type)+
   theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(y = NULL)


d_long_both %>% dplyr::filter(!is.na(value)) %>%
  dplyr::rename(Group = group) %>%
  ggplot2::ggplot(
    aes(x = Group, y = value, color = measure)
  )  + 
  geom_boxplot() +
  facet_wrap(~ type) +
   theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

# *Function to get Accuracy*

```{r}


# Function to read CSV and select specific columns
read_adhd_data <- function(file_path) {
  
  # Read the CSV file
  data <- read.csv(file_path)
  
  # Select only the required columns
  clean_data <- data %>%
    select(n_ADHD, 
           sensitivity_self_report, 
           specificity_self_report,
           size, ID)
  
  return(clean_data)
}

########################### Usage example
accuracy <- read_adhd_data(data_location)
#############################

# Check the result
head(accuracy)


calculate_adhd_stats <- function(data) {
  
  processed_data <- data %>%
    mutate(
      # 1. Calculate Prevalence (P / Total)
      Prevalence = n_ADHD / size,
      
      # 2. Calculate (1 - Prevalence)
      One_Minus_Prevalence = 1 - Prevalence,
      
      # 3. Create cleaner columns for Sensitivity/Specificity for the formula
      Sensitivity = sensitivity_self_report,
      Specificity = specificity_self_report,
      
      # 4. Calculate Accuracy
      # Formula: (Sens * Prev) + (Spec * (1 - Prev))
      Accuracy = (Sensitivity * Prevalence) + (Specificity * One_Minus_Prevalence)
    )
  
  return(processed_data)
}
accuracy <- calculate_adhd_stats(accuracy)
head(accuracy)


accuracy <- accuracy %>%
  select(-Sensitivity, -Specificity)

# Create and save in one pipe chain
output_file <- "accuracy.html"


# Create and save
kableExtra::kbl(accuracy) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  save_kable(file = output_file)

```

## *Program Summary of Findings Table*

```{r prog_summary}
# Test: combination
# Outcome: Clinical_misdiagnosis



CreateProgSummary <- function(test_outcome_and_result) {

  if (test_outcome_and_result == "cost_self_report") {
    test_outcome_and_result <- "cost_self.report"
  }
  
  reverse_min_max <- 
    stringr::str_detect(test_outcome_and_result, "sensitivity") | 
    stringr::str_detect(test_outcome_and_result, "specificity") 
  
  print(test_outcome_and_result)

  if (test_outcome_and_result %in% 
      c(
        "admin_self_report", 
        "admin_neuropsycho_tests", 
        "cost_neuropsycho_tests",
        "concordance_self_report",
        "concordance_neuropsycho_tests",
        "kappa_neuropsycho_tests",
        "kappa_neuroimaging")
      ) {
    return(
      data.frame(
        test_outcome_and_result = test_outcome_and_result,
        contributing_studies = "Misnamed variable (probably doesn't matter?)",
        primary_results  = "Misnamed variable"
        )
    )
  }
  
  
  non_numeric_question <- !is.numeric(d[[test_outcome_and_result]]) 
  
  d_now <-
    d %>%
    dplyr::mutate(!!rlang::sym(test_outcome_and_result) := as.numeric(!!rlang::sym(test_outcome_and_result))) %>%
    dplyr::filter(!is.na(!!rlang::sym(test_outcome_and_result)))
  
  n <- nrow(d_now)
  min_value <- min(d_now[[test_outcome_and_result]])
  max_value <- max(d_now[[test_outcome_and_result]])
  
  min_id <- d_now[which(d_now[[test_outcome_and_result]] == min_value), "Refid"] %>% paste0(., collapse = ", ")
  max_id <- d_now[which(d_now[[test_outcome_and_result]] == max_value), "Refid"] %>% paste0(., collapse = ", ")
  
  
  contributing_studies <- (glue::glue(
    "{paste(d_now$ID)}")
  ) %>% as.character() %>% paste(., collapse = "; ")
  
  if(non_numeric_question) {
    contributing_studies <- primary_results <- "Warning: non-numeric result."
  } else {
    contributing_studies <- 
      glue::glue("{n} studies ({contributing_studies})")
    if (!reverse_min_max) {
    primary_results <- 
      glue::glue(
        "{min_value}(#{min_id}) to {max_value}(#{max_id})"
        )
    } else {
      primary_results <- 
      glue::glue(
        "{max_value}(#{max_id}) to {min_value}(#{min_id})"
        )
    }
  
  }
  
  
  return(
    data.frame(
      test_outcome_and_result = test_outcome_and_result,
      contributing_studies = contributing_studies,
      primary_results = primary_results))
}
                
  
kq_outcome <- c(
  "clinical_misdiagnosis",
  "sensitivity",
  "specificity",
  "admin",
  "kappa",
  "ICC",
  "cost",
  "concordance"
)

kq_index_test <- c(
  "combination",
  "self_report",
  "peer_rating",
  "neuropsycho_tests",
  "neuroimaging",
  "EEG",
  "biomarker",
  "observational",
  "clinician_interview",
  "clinician_tool",
  "feigningADHD"
)  
 
all_kqs <- 
  expand_grid(kq_index_test, kq_outcome ) %>% 
  dplyr::select(kq_outcome, kq_index_test) %>% 
  apply(., 1, paste0, collapse = "_")



res <- lapply(all_kqs, CreateProgSummary)

writexl::write_xlsx(dplyr::bind_rows(res), "adhd_adults_diagnosis_SoF.xlsx")

```

```{r}
d$instrument_self_report <- stringr::word(d$test_description_self, 1)
```

## *Sensitivity and Specificity Meta-Analysis*

```{r}


```

```{r}
#| fig-width: 14
#| fig-height: 14



  
  # If you want to clean up any trailing spaces left behind:
d <- d %>%
  dplyr::mutate(
    study = gsub("\\{.*\\}", "", ID),
    study = trimws(study),
    study = ifelse(study == "van de Glind, 2013", "Van de Glind, 2013", study)
  )

d$instrument_self_report <- word(d$test_description_self, 1)


# Calculate Logit Sensitivity
dat_sens <- 
  metafor::escalc(
    measure="PLO", 
    xi=true_positive_self_report, 
    ni=(true_positive_self_report + false_negative_self_report), data=d, add=0.5)
dat_sens$outcome <- "sens" 
dat_sens <- dat_sens %>% dplyr::arrange(desc(study))


# Calculate Logit Specificity
dat_spec <- 
  metafor::escalc(
    measure="PLO", 
    xi=true_negative_self_report, 
    ni=(true_negative_self_report + false_positive_self_report), 
    data=d, add=0.5)
dat_spec$outcome <- "spec"
dat_spec <- dat_spec %>% dplyr::arrange(desc(study))

# Combine into long format
dat_long <- rbind(dat_sens, dat_spec)
dat_long <- dat_long[order(dat_long$study), ] # Group by study


all_studies <- dat_long %>%
  group_by(study, instrument_self_report) %>%
  # Keep studies where at least one row (sens or spec) is not NA
  filter(any(!is.na(yi))) %>%
  ungroup() %>%
  # Get the unique names and sort them alphabetically
  distinct(study) %>%
  arrange(desc(study)) %>%
  # Assign the fixed row numbers for the plots
  mutate(row_num = row_number())

res <- metafor::rma.mv(
  yi, vi, 
  mods = ~ outcome - 1,         # Separate means for sens and spec
  random = ~ outcome | study,   # Random effects for outcomes within studies
  struct = "UN",                # Unstructured covariance (estimates correlation)
  data = dat_long)

summary(res)

preds <- predict(res, newmods = diag(2), transf = transf.ilogit, digits = 3) %>%
  as.data.frame()
rownames(preds) <- c("Sensitivity", "Specificity")
print(preds)


dat_sens <- subset(dat_long, outcome == "sens") 

k <- length(dat_sens$yi) # Automatically count the studies

# 2. Create the forest plot with dynamic scaling
metafor::forest(dat_sens$yi, 
                vi = dat_sens$vi, 
                slab = dat_sens$study,
                transf = transf.ilogit, 
                # ylim: bottom is -2 for the diamond, top is k+3 for headers
                ylim = c(-2, k + 3), 
                rows = 1:k,
                header = "Study",
                main = "Sensitivity")

addpoly(res$beta[1], 
        sei = res$se[1], 
        row = -1, 
        transf = transf.ilogit, 
        mlab = "Pooled Sensitivity",
        col = "red")



dat_spec <- subset(dat_long, outcome == "spec") 

k <- length(dat_spec$vi) # Automatically count the studies

# 2. Create the forest plot with dynamic scaling
metafor::forest(dat_spec$yi, 
                vi = dat_spec$vi, 
                slab = dat_spec$study,
                transf = transf.ilogit, 
                # ylim: bottom is -2 for the diamond, top is k+3 for headers
                ylim = c(-2, k + 3), 
                rows = 1:k,
                header = "Study",
                main = "Specificity")

addpoly(res$beta[2], 
        sei = res$se[2], 
        row = -1, 
        transf = transf.ilogit, 
        mlab = "Pooled Specificity",
        col = "red")


all_studies <- dat_long %>%
  group_by(study) %>%
  # Keep studies where at least one row (sens or spec) is not NA
  filter(any(!is.na(yi))) %>%
  ungroup() %>%
  # Get the unique names and sort them alphabetically
  distinct(study) %>%
  arrange(desc(study)) %>%
  # Assign the fixed row numbers for the plots
  mutate(row_num = row_number())

# 2. Check the count (should be ~40 based on your current project)
k_total <- nrow(all_studies)
print(paste("Total studies in forest plot:", k_total))

# 1. Prepare data with dummy values and a color vector
dat_sens_plot <- all_studies %>% 
  left_join(filter(dat_long, outcome == "sens"), by = "study") %>%
  mutate(
    is_missing = is.na(yi),
    yi_plot = ifelse(is_missing, 0.5, yi),  # Provide a dummy value
    vi_plot = ifelse(is_missing, 0.001, vi), # Provide a tiny dummy variance
    # Create a color vector: "black" for real data, "white" for missing
    pt_col = ifelse(is_missing, "white", "black")
  ) %>%
  dplyr::arrange(instrument_self_report, study)

dat_spec_plot <- all_studies %>% 
  left_join(filter(dat_long, outcome == "spec"), by = "study") %>%
  mutate(
    is_missing = is.na(yi),
    yi_plot = ifelse(is_missing, 0.5, yi),
    vi_plot = ifelse(is_missing, 0.001, vi),
    pt_col = ifelse(is_missing, "white", "black")
  )%>%
  dplyr::arrange(instrument_self_report, study)

# set text size
cex = 0.6

# 1. Define a layout where the first column is nearly twice as wide as the second
# The widths = c(1.8, 1) ratio gives the left plot more 'breathing room'
layout(matrix(c(1, 2), nrow = 1), widths = c(1.5, 1))

# 2. Adjust margins: Reduce the left margin of the Specificity plot (plot 2)
# Sensitivity margins (standard)
par(mar = c(5, 4, 3, 1)) 

# --- SENSITIVITY ---
# Use a wider xlim to accommodate the text columns
xlim_sens <- c(-1, 1.5)

metafor::forest(dat_sens_plot$yi_plot, 
                vi = dat_sens_plot$vi_plot, 
                slab = dat_sens_plot$study,
                transf = transf.ilogit, 
                xlim = xlim_sens,        
                ylim = c(-2, k_total + 3), 
                rows = all_studies$row_num,
                col = dat_sens_plot$pt_col,
                header = "Study", 
                main = "Sensitivity", 
                refline = NA,
                cex = cex)

text(-0.5, k_total + 2, "Instrument", pos = 4, cex = cex, font = 2) 
text(-0.5, all_studies$row_num, dat_sens_plot$instrument_self_report, pos = 4, cex = cex)

addpoly(res$beta[1], sei = res$se[1], row = -1, 
        transf = transf.ilogit, mlab = "", col = "red", cex = cex)

# 3. Switch to the second plot and tighten its margins
par(mar = c(5, 1, 3, 2)) 

# --- SPECIFICITY ---
# Use a much tighter xlim since there are no labels on the left
xlim_spec <- c(-0.5, 1.5)

metafor::forest(dat_spec_plot$yi_plot, 
                vi = dat_spec_plot$vi_plot, 
                slab = NA,                       
                transf = transf.ilogit, 
                xlim = xlim_spec,
                ylim = c(-2, k_total + 3), 
                rows = all_studies$row_num,
                col = dat_spec_plot$pt_col,
                header = "", 
                main = "Specificity", 
                refline = NA,
                cex = cex)

addpoly(res$beta[2], sei = res$se[2], row = -1, 
        transf = transf.ilogit, mlab = "", col = "red", cex = cex)

```

```{r}

```
